## Factom联合服务器如何管理链

作为核心，Factom以一种去中心化的方式来收集，打包，并保护比特币区块链的数据。Factom用联合服务器组成的网络来实现这个功能。这些服务器系统的不同方面工作。任何单一的服务器都不能控制整个系统，而只是控制系统中的一部分。也没有任何一个服务器永久地控制系统中固定的某一部分；每分钟，Factom系统中每个部分的功能都在多个服务器之间轮换。

每个联合服务器需要在目录区块的开创始之初对用户的链负责。工作过程是这样的：

1. 所有服务器重置其进程列表为空。
2. 用户使用与条目信用关联的公共密钥为条目提交付款
3. 根据用于支付条目的公共密钥，其中一台服务器接受支付。
4. 服务器公布已经接受了支付。
5. 用户看到支付已被接受，提交条目。
6. 根据条目的ChainID，其中一台服务器把它加入其进程列表，并把条目添加进适合ChainID的条目区块（如果是该条目区块中的第一个条目，创建一个区块）。
7. 服务器广播对条目的确认，包含该条目在进程列表中的索引，该条目的哈希值（链接到付款），以及目前为止服务器的进程列表中的序列哈希值。
8. 所有其他服务器更新它们记录的该服务器的进程列表，验证该进程列表，并更新它们所记录的拥有该ChainID的条目区块。
9. 只要用户能够验证保管他们的条目的相关进程列表，那么他们就有相当大的把握确信条目会被成功加入Factom系统。
10.  在这一分钟结束时，所有服务器确认进程列表高度，揭示一个确定的秘密数字（反向哈希，*表示*长哈希链的连续原像）和进程区块的序列哈希值（指向进程列表中的最后一项）。
11. 这一分钟的目录区块是由所有服务器定义的所有条目区块构成的。因此，每个服务器存有所有条目区块，所有的目录块，和所有的条目。
12. 把反向哈希的集合结合起来，创建一个在服务器中重新分配下一轮的ChainIDs的种子。
13. 在完成第10个目录区块时，执行以下操作：
 1. 创建最后一分钟的条目区块的Merkle根，按照Chain排序ID。
 2. 创建最后一分钟的目录区块，并计算其Merkle根
 3. 从10块目录的Merkle根的Merkle根创建一个锚。
 4. 把服务器的反向哈希结合起来创建一个种子，选择
服务器把锚写入比特币。
14. 重复（回到1）。

联合服务器在这一分钟中创建了他们所负责的链的进程列表，以及将在这一分钟结束时将被用于创建目录区块的条目区块。在服务器将其做出的决定广播给网络中其它部分时，进程列表起着重要作用。

联合服务器每四个小时重新排序。排名是用户投票的函数。用户必须在Factom中创建个人资料链。该账户包含任意数量的已签名的公共地址条目。用户的投票权重由他们的个人资料的公共地址确定：。计算公共地址权重的函数是如下部分的和：
- 在过去六个月购买的条目信用（每个月的购买量的总和，本月加权乘6，上个月加权乘5，以此类推）的加权数
- 在过去六个月使用的条目（每个月的使用量的总和，本月加权乘6，上个月加权乘5，以此类推）的加权数

当有n个服务器运行时，世界排名前n个服务器是联合服务器，而另一个n为审计服务器。所有服务器基于用户为它们投票的数量维持等级。数字n最初指定为16，但这个数字n由社区辩论决定，并且可以基于交易量浮动。
所有服务器必须在每一个心跳周期广播一次心跳。（一项条目确认广播可以替代一次心跳。）如果超时以后，服务器仍然没有收到心跳或者已核实的条目，服务器广播服务器故障消息（SFM）。如果网络中大多数服务器对某一个服务器广播了SFM，该联合服务器被认为是“故障”，并沦为被审计服务器，在接下来的排名中由审核服务器接管。升级的服务器将工作到当前4小时任期结束。
在后续的对服务器的重新排序时，发生故障的服务器必须在另一个满任期中被排除在外。
心跳周期和超时时间可以由大多数联合服务器按照配置链中的文档修改。根据比特币传送时间，心跳周期是4秒，超时时间是8秒。

更多关于Factom共识的细节，以及我们正在开发的算法，可在工作文件《Factom共识》中找到。

